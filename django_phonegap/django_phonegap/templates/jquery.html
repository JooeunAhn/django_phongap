<script>
$(document).ready(function(){
    $username = ""
    $userApikey = ""
    $("#submit").click(function(e){
        e.preventDefault();
        var submitBTN = $(this)
        submitBTN.attr("disabled", "disabled")
        username = $("#username").val()
        var password = $("#password").val()
        var encodedString = btoa(username + ":" + password)
        var endPoint = "http://localhost:8000/api/v1/login/?format=json"
        $.ajax({
            type: "GET",
            url: endPoint,
            data: {},
            success: function(data){
                userApikey = data.objects[0].api_key
                $.mobile.navigate("#listPage");
            },
            beforeSend: function(xhr){
                xhr.setRequestHeader("Authorization", "Basic " + encodedString)
            },
            error: function(data){
            },
            complete: function(){
                submitBTN.prop("disabled", false)
            }
        })
    });

    $("#newRecord").click(function(e){
        e.preventDefault();
        var newApiString = username + ":" + userApikey
        var endPoint = "http://localhost:8000/api/v1/posting/"
        var data = JSON.stringify({
            "post":"'" + $("#postText").val() +"'",
        })
        $.ajax({
            type: "POST",
            url: endPoint,
            data: data,
            contentType: "application/json",
            success: function(data){
                console.log(data);
            },
            beforeSend: function(xhr){
                xhr.setRequestHeader("Authorization", "ApiKey " + newApiString)
            },
            error: function(data){
                console.log(data);
            },
            complete: function(data){
                console.log(data);
            }
        })
    });

    function getPostingData(listId){
        console.log("getting...data");
        var newApiString = username + ":" + userApikey
        var endPoint = "http://localhost:8000/api/v1/posting/"
        var data = JSON.stringify({})
        $.ajax({
            type: "GET",
            url: endPoint,
            data: data,
            contentType: "application/json",
            success: function(data){
                var objectArray = data.objects;
                $.each(objectArray, function(){
                    var listItemSingle = $(this);
                    $(listId).append("<li class=\"ui-li-static ui-body-inherit\">"+listItemSingle[0].post+"</li>" );
                    console.log($(this))
                })
            },
            beforeSend: function(xhr){
                xhr.setRequestHeader("Authorization", "ApiKey " + newApiString)
            },
            error: function(data){
                console.log(data);
            },
            complete: function(data){
                console.log(data);
            }
        })
    }

    $(window).on("navigate", function(event){
        var pageId = $.mobile.activePage.attr("id")
        if (pageId == "two"){
            console.log(userApikey);
            $("#" + pageId + " .ui-content").html("<form id='postForm' ><input type='text' id='postText'/></form>");
        }
        else if(pageId=="listPage"){
            getPostingData("#listPostings");
        }
    });
});

</script>